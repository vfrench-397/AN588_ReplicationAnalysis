---
title: "AN588 Final Replication Analysis"
author: "Victoria French"
date: "12/10/2021"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    theme: yeti 
---

# Effects of stand age and soil organic layer depth on legacy C retention in boreal forest soils post burning events 

A replication of data analysis presented in Walker et al (2019) Increasing wildfires threaten historic carbon sink of boreal forest soils. 

```{r, message = FALSE}
library(ggplot2)
library(lmtest)
library(effects)
library(broom)
```

```{r}
site.data <- read.csv(file = 'Radiocarbon_site_data.csv', header = TRUE, stringsAsFactors = TRUE) #general site information
soil.data <- read.csv(file = 'Soil_radiocarbon_data.csv', header = TRUE, stringsAsFactors = TRUE) #carbon-14 quantities 
```

## Background 

Boreal regions have extremely thick soil organic layers due to their relatively slow rates of decomposition. Meaning they can be extremely effective in storing and retaining large amounts of C, and preventing it from being emitted to the atmosphere and contributing to the formation of greenhouse gases.  

When wildfires sweep through boreal regions, they combust the exposed soil organic layer, releasing stored C to the atmosphere. Due to the thick nature of these soil organic layers (SOLs), combustion is restricted to a proportion of the entire SOL. The portion that is unaffected by the most recent burning event is termed 'legacy carbon'. 

With increasing frequency and severity of wildfire events as a result of global warming, these legacy carbon pools are under threat.

This analysis uses relative radiocarbon dating of the carbon-14 isotope to assess the proportion of sites across the Northwest Territory, Canada that possessed and retained their legacy C pools after burning events in 2014. Legacy C was identified (through radiocarbon dating) as any organic soil C that is older than the stand age (time since previous burning event). 


## Experimental Design 

In 32 plots Delta 14 C (parts per thousand difference between sample carbon-14:carbon-12 and the international standard ratio) was measured at several soil depth increments. The 32 plots were assigned a moisture class (based on their topography, drainage, presence of permafrost and their soil class) and a stand age class (young < 60 years since previous burning event, old > 70 years, based on the historic fire return interval of North American northwest coast boreal ecosystems). 

Soil samples were dated (based on delta 14 C values) relative to a known historic peak C level from nuclear bomb testing in the area (further known as bomb peak). 

Site establishment was dated based on tree rings. 

## Hypotheses

The most significant predictors of legacy C presence and retention will be soil moisture class and stand age as these are reported to be the most influential factors contributing to SOL combustion and accumulation.

1. Legacy C would be present more frequently in wet ecosystems (high soil organic matter (SOM) C accumulation due to low decomposition rates and low burn severity). Legacy C would be present less frequently (if at all) in dry ecosystems (low SOM accumulation and higher severity burns)
2. Legacy C more likely to combust in historically moist (moderate) ecosystems due to their larger legacy C pools (ability to harbor legacy C previously) and their higher burn risk under drought and increasing wildfire severity.
3. Legacy C more likely to combust in young stands because the natural protective layer of SOM has not yet re-accumulated. 

## Presence of Legacy C

To identify plots that possess legacy C, the delta 14 C values of the basal organic soil layer were compared to delta 14 CO2 values of the atmosphere during the year of stand establishment. 

Legacy C was considered present if the base of the SOL was older than the year of stand establishment (meaning delta 14 C lower (decayed for longer) than delta 14 CO2). 

Therefore the first step is to extract basal SOL C values from the larger data set. 
```{r}
basal.layer <- soil.data[soil.data$increment_location == 'BOTTOM', ]
basal.layer <- basal.layer[duplicated(basal.layer$burned_site_plot) == FALSE,] 
```

Next we determine and label the presence/absence of legacy carbon for each plot. 
```{r}
basal.layer$LC <- NULL
for (i in 1:nrow(basal.layer)) {
  if (basal.layer$Delta14C[i] < basal.layer$X14C_yr_stand_age[i]) {
    basal.layer$LC[i] <- 'Present'
  }
  else {
    basal.layer$LC[i] <- 'Absent'
  }
}
```

```{r}
sum(basal.layer$LC == 'Present') #number of sites determined to possess legacy C 
```

### Data Visualization 

To visualize this conclusion, we must manipulate the data, combine the carbon measurements of the basal soil layer and the atmosphere at stand establishment into a single variable, for the ggplot object. 
```{r}
basal.carbon <- basal.layer[,c('burned_site_plot', 'soil_depth_increment', 'Delta14C', 'soil_class_pre.post_bomb', 'stand_age_pre.post_bomb', 'LC')]
basal.carbon$type <- 'Soil.Base'
names(basal.carbon) <- c('Plot', 'Depth', 'Delta.14.C', 'Soil.Class','Stand.Class','LC', 'Location')
basal.stand.age <- basal.layer[,c('burned_site_plot', 'soil_depth_increment', 'X14C_yr_stand_age', 'soil_class_pre.post_bomb', 'stand_age_pre.post_bomb', 'LC')]
basal.stand.age$type <- 'Stand.Age'
names(basal.stand.age) <- c('Plot', 'Depth', 'Delta.14.C', 'Soil.Class', 'Stand.Class','LC', 'Location')
legacy.carbon <- rbind(basal.carbon, basal.stand.age)
```

And divide the legacy carbon data set into pre and post bomb peak sites. 
```{r}
legacy.carbon.pre <- legacy.carbon[legacy.carbon$Stand.Class == 'pre',]
legacy.carbon.post <- legacy.carbon[legacy.carbon$Stand.Class == 'post',]
```

Then we can plot basal layer delta 14 C against atmospheric delta 14 CO2 at time of stand establishment (pre bomb peak) (Figure 2 from original paper)
```{r}
ggplot(legacy.carbon.pre, aes(x= Location, y = Delta.14.C)) + geom_point(aes(shape = Location, color = Location), size = 3) + geom_line(aes(group = Plot, linetype = LC), color = 'black') + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = NULL, y = 'Delta 14 Carbon (parts per thousand)', linetype = 'Legacy Carbon')
```

and plot basal layer delta 14 C against atmospheric delta 14 CO2 at time of stand establishment (post bomb peak) (Figure 2 from original paper)
```{r}
ggplot(legacy.carbon.post, aes(x= Location, y = Delta.14.C)) + geom_point(aes(shape = Location, color = Location), size = 3) + geom_line(aes(group = Plot, linetype = LC), color = 'black') + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = NULL, y = 'Delta 14 Carbon (parts per thousand)', linetype = 'Legacy Carbon') + scale_linetype_manual(values = 'dashed')
```

We can also visualize the relationship between Legacy C presence and our expected predictor variables. 

```{r}
log.r.data <- cbind(basal.layer, site.data)
log.r.data <- log.r.data[,-c(21,22)]
```

Legacy Carbon v. Stand Age 
```{r}
ggplot(data = log.r.data, aes(x = LC, y = stand_age_rings)) + geom_boxplot(aes(color = LC)) + theme_bw() + labs(x = 'Legacy Carbon', y = 'Stand Age (yr)') + scale_color_manual(values = c('darkgreen', 'darkred')) + theme(legend.position="none") + geom_hline(aes(yintercept = 60), linetype = 'dashed')
```

We can see from comparing the basal layer C levels of old and young plots that they have similar delta 14 C levels which indicates they both underwent similar cycles of accumulation/combustion in previous burn cycles. Therefore the large proportion of young stands harboring legacy C could be due to the young soils not yet re-accumulating their C stocks. 

```{r}
ggplot(data = log.r.data, aes(x = stand_age_class, y = Delta14C)) + geom_boxplot(aes(color = stand_age_class)) + theme_bw() + labs(x = 'Stand Age', y = 'Delta 14 C (parts per thousand)') + scale_color_manual(values = c('darkgreen', 'darkred')) + theme(legend.position="none")
```

Legacy Carbon v. Prefire SOL Depth 
```{r}
ggplot(data = log.r.data, aes(x = LC, y = prefire_sol_depth)) + geom_boxplot(aes(color = LC)) + theme_bw() + labs(x = 'Legacy Carbon', y = 'Prefire SOL depth (cm)') + scale_color_manual(values = c('darkgreen', 'darkred')) + theme(legend.position="none")
```

Legacy C present in all plots with prefire SOL depth > 30 cm (indicative of wetter ecosystems). 

We are using prefire SOL depth as a proxy for moisture class.
```{r}
ggplot(data = log.r.data, aes(x = moisture_class, y = prefire_sol_depth)) + geom_boxplot(aes(color = LC)) + theme_bw() + labs(x = 'Moisture Class', y = 'Prefire SOL depth (cm)') + scale_color_manual(values = c('darkgreen', 'darkred', 'darkblue')) 
```

### Multiple Logistic Regression

We will generate a generalized linear model for this data because we cannot assume a normal distribution of our response variable or its residuals and therefore cannot fit the assumptions of a general linear model. We use a logistic regression, a form of a generalized linear model, because our response variable is binary (presence or absence of legacy C) so we must use the logit link function to calculate the natural log of the odds ratio between our two possible outcomes and use that output as our response variable. 

When preparing the data to be placed into the glm function we need to make sure our variables are factored to avoid fitting errors when running the regression. 
```{r}
log.r.data$LC <- as.factor(log.r.data$LC)
levels(log.r.data$LC)
```

#### Model Selection 

To evaluate the model significance we can compare model fit between a full, a reduced and a null model. In our case the full model will include the interaction terms between the predictor variables stand age and SOL depth. The reduced model will remove only the interaction term between the two predictor variables and the null model will be an intercept only model. 
 
```{r}
full.presence <- glm(data = log.r.data, formula = LC ~ prefire_sol_depth*stand_age_rings, family = binomial)
summary(full.presence)
```


```{r}
reduced.presence <- glm(data = log.r.data, formula = LC ~ prefire_sol_depth + stand_age_rings, family = binomial)
summary(reduced.presence)
```

```{r}
null.presence <- glm(data = log.r.data, formula = LC ~ 1, family = binomial)
summary(null.presence)
```

We can compare the models using a log likelihood test which utilizes a ratio of the log-likelihoods as the test statistic and utilizes the Chi-squared distribution to calculate the p-values. Therefore we can run a log-likelihood test by arguing the two models to the ```anova()``` function and additionally including ```test = 'Chisq'``` argument. 

```{r}
anova(reduced.presence, full.presence, test = 'Chisq') 
```

Here the chi-squared p value is not significant so the inclusion of the interaction term does not significantly decrease deviance and we can resume with the reduced model. 

We can also run a log -likelihood test using the ```lrtest()``` from the {lmtest} package 

```{r}
lrtest(reduced.presence, full.presence) 
```

Here the higher log likelihood value indicates a greater model fit, but the chi-squared p value is not significant so even though the full model has a 'better' fit it is not significantly better. Therefore, again we can proceed with utilizing the reduced model for our analysis.  

Next, we must compare the accepted model, the reduced model, against the null model

```{r}
anova(null.presence, reduced.presence, test = 'Chisq') 
```

Here the chi-squared p value is less than alpha (.05) meaning the fuller model is associated with less residual deviance and therefore is a better fit! We can reject the null hypothesis that the removal of the predictor variables does not result in a loss of fit and proceed with utilizing the reduced model for our analysis. 

#### Interpretation 

Our slope estimate (Beta1) now represents the associated change in the response variable (which if we remember is the natural log of the odds ratio) with an increase in the predictor variable of 1 unit. 

The coefficient/estimate for prefire SOL depth was positive. Therefore increasing prefire SOL depth results in an increased likelihood of legacy C being present. For every one cm of prefire SOL depth, the probability of legacy being present increases by 0.079485. Where the estimate for stand age is negative indicating every year the stand ages the likelihood of legacy C being present decreased by  0.014321. Even though neither of these relationships showed a significant p-value. 

In order to get the actual odds ratio we must back transform the estimates using the reverse of the link function.

```{r}
SOL.depth.change <- exp(reduced.presence$coefficients[2])
stand.age.change <- exp(reduced.presence$coefficients[3])

SOL.depth.change
stand.age.change
```

1 unit increase in SOL depth results in a 8.2 % increase in the likelihood of Legacy C presence 
1 unit increase in stand age results in a 1.4% decrease in the likelihood of Legacy C presence

#### Hypothesis Testing 

To test our null hypothesis that the response variable (Legacy C presence) and our predictor variables have no relationship, we can calculate the Wald statistic (similar to a t-statistic) for each predictor variable and compare them to the z distribution. 

Calculating the Wald Statistic for SOL depth 
```{r}
library(broom)
modelresults <- tidy(reduced.presence)
wald <- modelresults$estimate[2]/modelresults$std.error[2]
p <- 2 * (1 - pnorm(wald))  # calculation of 2 tailed p value associated with the Wald statistic
p
```

for stand age
```{r}
library(broom)
modelresults <- tidy(reduced.presence)
wald <- modelresults$estimate[3]/modelresults$std.error[3]
p <- 2 * (1 - pnorm(wald))  # calculation of 2 tailed p value associated with the Wald statistic
p
```
 
Again neither predictor variable seems to show a significant p-value. 

#### Confidence Intervals 

Finally, we can calculate the confidence intervals around our estimates 
```{r}
CI <- confint.default(reduced.presence, level = 0.95) # this function returns CIs based on standard errors instead of based on log-likelihood 
CI
```

Calculating the CIs for the actual odds ratios
```{r}
SOL.depth.changeCI <- exp(CI[2, ]) #for prefire SOL depth
stand.age.changeCI <- exp(CI[3, ]) #for stand age 

SOL.depth.changeCI
stand.age.changeCI
```

#### Plotting (Figure 3 from original paper) 

We can also visualize the individual predictors effects on the model using the [{effects} package](https://cran.r-project.org/web/packages/effects/index.html) 

Originally found as a solution on [stack overflow](https://stackoverflow.com/questions/42191567/how-to-plot-predictions-of-binomial-glm-that-has-both-continuous-and-categorical)

```{r}
effects.depth <- as.data.frame(effect('prefire_sol_depth', reduced.presence, xlevels = 32))
```

Also before we create the ggplot object we can transform the factored response variable (presence) into a binary value for easier data plotting. 
```{r}
log.r.data$LC.bin <- NULL 
for (i in 1:nrow(log.r.data)) {
  if (log.r.data$LC[i] == 'Present') {
    log.r.data$LC.bin[i] <- 1
  }
  else {
    log.r.data$LC.bin[i] <- 0
  }
}
```

Effect of prefire SOL depth on the probability of legacy C presence. 
```{r}
p <- ggplot(data = effects.depth, aes(x= prefire_sol_depth, y = fit)) + geom_line() + geom_ribbon(aes(ymin = effects.depth$lower, ymax = effects.depth$upper), alpha = .2) + labs(x = "Prefire SOL depth (cm)", y ="Pr(Present)", color = 'Moisture Class', shape = 'Stand Age') + geom_point(data = log.r.data, aes(x = prefire_sol_depth, y = LC.bin, color = moisture_class, shape = stand_age_class), size = 3.5) + theme_bw() + scale_color_manual(values = c('darkgreen', 'darkred','darkblue'))
p
```

Effect of stand age on the probability of legacy C presence.
```{r}
effects.age <- as.data.frame(effect('stand_age_rings', reduced.presence, xlevels = 32))
```

```{r}
p <- ggplot(data = effects.age, aes(x= stand_age_rings, y = fit)) + geom_line() + geom_ribbon(aes(ymin = effects.age$lower, ymax = effects.age$upper), alpha = .2) + labs(x = "Stand Age (yr)", y ="Pr(Present)", color = 'Moisture Class', shape = 'Stand Age') + geom_point(data = log.r.data, aes(x = stand_age_rings, y = LC.bin, color = moisture_class, shape = stand_age_class), size = 3.5) + theme_bw() + scale_color_manual(values = c('darkgreen', 'darkred','darkblue')) + geom_vline(aes(xintercept = 60), linetype = 'dashed')
p
```


## Soil surface dating relative to bomb peak

Here we will determine the surface soil establishment date relative to bomb peak by comparing delta 14 C levels at the soil surface to delta 14 C levels at soil depth increment of 2 cm. In natural states, depth should have less C because it is older (more C has decayed & surface layers accumulate vertically). Therefore, if C levels are higher at the surface than at the 2cm depth then the surface is dated as pre bomb peak. If the soil surface has less C than the 2cm depth, the surface layer is determined to be established post bomb peak. These classifications will be important for when we determine legacy C combustion later in the analysis. 

Extract surface layer measurements 
```{r}
surface.layer <- soil.data[soil.data$increment_location == 'TOP',]
surface.layer$soil_depth_increment <- as.factor(surface.layer$soil_depth_increment)
```

Assigning stand age class (young; < 60 years or old > 70 years) based on the tree ring dates. 
```{r}
surface.layer$Age <- NULL
for (i in 1:nrow(surface.layer)) {
  if (surface.layer$stand_age_rings[i] < 60) {
    surface.layer$Age[i] <- 'Young'
  }
  else {
    surface.layer$Age[i] <- 'Old'
  }
}
```

### Data Visualization 

Here we plot the delta 14 C at both soil increments to determine the relative soil surface dates

```{r}
ggplot(surface.layer, aes(x = soil_depth_increment, y = Delta14C)) + geom_point(aes(shape = soil_depth_increment, color = soil_depth_increment), size = 3) + geom_line(aes(group = site_sample_transect, linetype = soil_class_pre.post_bomb)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = 'Soil Depth', y = 'Delta 14 Carbon (parts per thousand)', color = 'Soil Depth', shape = 'Soil Depth', linetype = 'Soil Surface Est. relative to bomb peak')
```

We can also graph the pre-bomb and post-bomb sites separately to show the relationship of delta 14 C between the 2 soil increments more clearly. 

Divide into pre and pot bomb peak data. 
```{r}
surface.layer.pre <- surface.layer[surface.layer$soil_class_pre.post_bomb == 'pre', ]
surface.layer.post <- surface.layer[surface.layer$soil_class_pre.post_bomb == 'post', ]
```


Plot soil surface (soil depth increment of 1) to soil depth increment 2. (pre bomb peak) (Figure 2 from original paper)
```{r}
ggplot(surface.layer.pre, aes(x = soil_depth_increment, y = Delta14C)) + geom_point(aes(shape = soil_depth_increment, color = soil_depth_increment), size = 3) + geom_line(aes(group = site_sample_transect, linetype = Age)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = 'Soil Depth', y = 'Delta 14 Carbon (parts per thousand)', color = 'Soil Depth', shape = 'Soil Depth') + scale_x_discrete(labels = c('Surface','2 cm'), breaks = c(1,2))
```

Plot soil surface (soil depth increment of 1) to soil depth increment 2. (post bomb peak) (Figure 2 from original paper)

```{r}
ggplot(surface.layer.post, aes(x = soil_depth_increment, y = Delta14C)) + geom_point(aes(shape = soil_depth_increment, color = soil_depth_increment), size = 3) + geom_line(aes(group = site_sample_transect, linetype = Age)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = 'Soil Depth', y = 'Delta 14 Carbon (parts per thousand)', color = 'Soil Depth', shape = 'Soil Depth') + scale_x_discrete(labels = c('Surface','2 cm'), breaks = c(1,2))
```

## Combustion of Legacy C

To assess if legacy C was combusted during the burning event the delta 14 C values of the soil surface samples was compared to atmospheric delta 14 CO2 values at the time of stand establishment (in plots where Legacy C was considered present). Legacy C was considered combusted if the soil surface was older than the stand age. 

Therefore legacy C was combusted in the plot IF: 

1) Soil surface C levels were lower than stand age CO2 levels in sites where the stand age was pre bomb peak AND the soil surface was pre bomb peak. (natural state, so if the soil surface was older, it would have less C than atmosphere at the time of site establishment)

2) The stand age was dated post bomb peak AND the soil surface was dated pre bomb peak 

3) The soil surface C levels were higher than stand age CO2 levels in sites where the stand age was post bomb peak AND the soil surface was post bomb peak. 

Note: legacy C was not combusted if the stand age was pre bomb peak and the surface was post bomb peak.

First we can extract the soil surface delta 14 C values. 
```{r}
top.surface.layer<- surface.layer[surface.layer$soil_depth_increment == 1,]
top.surface.layer <- top.surface.layer[duplicated(top.surface.layer$burned_site_plot) == FALSE,] 
```

Then extract plots where Legacy C was present. 
```{r}
top.surface.layer$LP <- basal.layer$LC
```

```{r}
legacy.plots <- top.surface.layer[top.surface.layer$LP == 'Present',]
```

Then we must identify and label combustion status for each plot. 
```{r}
legacy.plots$LC <- NULL 
for (i in 1:nrow(legacy.plots)) {
  if (legacy.plots$stand_age_pre.post_bomb[i] == 'pre' & legacy.plots$soil_class_pre.post_bomb[i] == 'pre'){
    if (legacy.plots$Delta14C[i] < legacy.plots$X14C_yr_stand_age[i]){
      legacy.plots$LC[i] <- 'Combusted'
    }
    else {
      legacy.plots$LC[i] <- 'Not.Combusted'
    }
  }
  else if (legacy.plots$stand_age_pre.post_bomb[i] == 'post' & legacy.plots$soil_class_pre.post_bomb[i] == 'pre') {
      legacy.plots$LC[i] <- 'Combusted'
    }
  else if (legacy.plots$stand_age_pre.post_bomb[i] == 'pre' & legacy.plots$soil_class_pre.post_bomb[i] == 'post') {
      legacy.plots$LC[i] <- 'Not.Combusted'
    }
  else if (legacy.plots$stand_age_pre.post_bomb[i] == 'post' & legacy.plots$soil_class_pre.post_bomb[i] == 'post') {
       if (legacy.plots$Delta14C[i] < legacy.plots$X14C_yr_stand_age[i]){
      legacy.plots$LC[i] <- 'Not.Combusted'
    }
    else {
      legacy.plots$LC[i] <- 'Combusted'
    }
  }
}

```

### Data Visualization 

Manipulate the data for the ggplot object
```{r}
surface.carbon <- legacy.plots[,-17]
surface.carbon$Location <- 'Soil.Surface'
colnames(surface.carbon)[12] <- 'Delta14C'
surface.stand.age <- legacy.plots[,-12]
surface.stand.age$Location <- 'Stand.Age'
colnames(surface.stand.age)[16] <- 'Delta14C'

legacy.combustion <- rbind(surface.carbon, surface.stand.age)
```

Plot the soil surface C levels against the atmospheric C at the time of stand establishment for all of the sites 
```{r}
ggplot(legacy.combustion, aes(x= Location, y = Delta14C)) + geom_point(aes(shape = Location, color = Location), size = 3) + geom_line(aes(group = site_sample_transect, linetype = LC)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = NULL, y = 'Delta 14 Carbon (parts per thousand)', linetype = 'Legacy Carbon') + scale_linetype_manual(values = c('dashed', 'solid'))
```

Here we can't see any clear relationship between the delta 14 C levels of each location. It would be more beneficial to subset the sites into their soil and stand age relative to the bomb peak to really see patterns in how legacy C combustion was determined. 

So first we can subset the legacy plot data set 
```{r}
legacy.combustion.pre.pre <- legacy.combustion[legacy.combustion$stand_age_pre.post_bomb == 'pre' & legacy.combustion$soil_class_pre.post_bomb == 'pre',]
legacy.combustion.post.pre <- legacy.combustion[legacy.combustion$stand_age_pre.post_bomb == 'post' & legacy.combustion$soil_class_pre.post_bomb == 'pre',]
legacy.combustion.pre.post <- legacy.combustion[legacy.combustion$stand_age_pre.post_bomb == 'pre' & legacy.combustion$soil_class_pre.post_bomb == 'post',]
legacy.combustion.post.post <- legacy.combustion[legacy.combustion$stand_age_pre.post_bomb == 'post' & legacy.combustion$soil_class_pre.post_bomb == 'post',]
```

And then plot each set of sites seperately. 

Pre bomb peak stand age and pre bomb peak soil age (Figure 2 from original paper)
```{r}
ggplot(legacy.combustion.pre.pre, aes(x= Location, y = Delta14C)) + geom_point(aes(shape = Location, color = Location), size = 3) + geom_line(aes(group = site_sample_transect, linetype = LC)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = NULL, y = 'Delta 14 Carbon (parts per thousand)', linetype = 'Legacy Carbon') + scale_linetype_manual(values = c('dashed', 'solid'))
```

Post bomb peak stand age and pre bomb peak soil age (Figure 2 from original paper)
```{r}
ggplot(legacy.combustion.post.pre, aes(x= Location, y = Delta14C)) + geom_point(aes(shape = Location, color = Location), size = 3) + geom_line(aes(group = site_sample_transect, linetype = LC)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = NULL, y = 'Delta 14 Carbon (parts per thousand)', linetype = 'Legacy Carbon') + scale_linetype_manual(values = c('dashed', 'solid'))
```

Pre bomb peak stand age and post bomb peak soil age (Figure 2 from original paper)
```{r}
ggplot(legacy.combustion.pre.post, aes(x= Location, y = Delta14C)) + geom_point(aes(shape = Location, color = Location), size = 3) + geom_line(aes(group = site_sample_transect, linetype = LC)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = NULL, y = 'Delta 14 Carbon (parts per thousand)', linetype = 'Legacy Carbon') + scale_linetype_manual(values = c('dashed', 'solid'))
```

Post bomb peak stand age and post bomb peak soil age (Figure 2 from original paper)
```{r}
ggplot(legacy.combustion.post.post, aes(x= Location, y = Delta14C)) + geom_point(aes(shape = Location, color = Location), size = 3) + geom_line(aes(group = site_sample_transect, linetype = LC)) + theme_bw() + scale_color_manual(values = c('darkgreen','darkred')) + labs(x = NULL, y = 'Delta 14 Carbon (parts per thousand)', linetype = 'Legacy Carbon') 
```

Similar to when we were assessing legacy C presence or absence, we can look at the combustion status relationship with our expected predictor variables. 

First we must extract the appropriate plots (where Legacy C was present)
```{r}
combustion.r.data <- log.r.data[log.r.data$LC == 'Present',]
combustion.r.data$combustion <- legacy.plots$LC
```

Combustion v. Prefire SOL depth (as a proxy for moisture class)
```{r}
ggplot(data = combustion.r.data, aes(x = combustion, y = prefire_sol_depth)) + geom_boxplot(aes(color = combustion)) + theme_bw() + labs(x = 'Legacy Carbon', y = 'Prefire SOL depth (cm)') + scale_color_manual(values = c('darkgreen', 'darkred')) + theme(legend.position="none")
```

Combustion v. Stand Age 
```{r}
ggplot(data = combustion.r.data, aes(x = combustion, y = stand_age_rings)) + geom_boxplot(aes(color = combustion)) + theme_bw() + labs(x = 'Legacy Carbon', y = 'Stand Age (yr)') + scale_color_manual(values = c('darkgreen', 'darkred')) + theme(legend.position="none") + geom_hline(aes(yintercept = 60), linetype = 'dashed')
```

No evidence for combustion in old burned sites, drier and younger sites combusted more frequently. 

### Multiple Logistic Regression

To test our hypotheses for Legacy C combustion, we again must use a generalized linear model using the log link function as our response variable of combustion status is also binary. In this case our model will look at the predictor variables of stand age and the proportion of the soil organic layer burned (as a proxy for fire severity)

So first we must factor our response variable and calculate the proportion of the soil organic layer burned from the burn depth and the prefire sol depth. 
```{r}
combustion.r.data$combustion <- factor(combustion.r.data$combustion, levels = c('Not.Combusted', 'Combusted'))
levels(combustion.r.data$combustion) #important to factor in the correct order for glm model interpretation
combustion.r.data$proportion_sol_burned <- combustion.r.data$burn_depth/combustion.r.data$prefire_sol_depth
```

Then we can move onto model selection 

#### Model Selection 

To evaluate the model significance we can compare model fit between a full, a reduced and a null model. In our case the full model will include the interaction terms between the predictor variables stand age and SOL depth. The reduced model will remove only the interaction term between the two predictor variables and the null model will be an intercept only model. 

```{r}
full.combustion <- glm(data = combustion.r.data, formula = combustion ~ proportion_sol_burned * stand_age_rings, family = binomial)
summary(full.combustion) 
```

```{r}
reduced.combustion <- glm(data = combustion.r.data, formula = combustion ~ proportion_sol_burned + stand_age_rings, family = binomial)
summary(reduced.combustion) 
```


```{r}
null.combustion <- glm(data = combustion.r.data, formula = combustion ~ 1, family = binomial)
summary(null.combustion) 
```

We can compare the models using a log likelihood test which utilizes a ratio of the log-likelihoods as the test statistic and utilizes the Chi-squared distribution to calculate the p-values. Therefore we can run a log-likelihood test by arguing the two models to the ```anova()``` function and additionally including ```test = 'Chisq'``` argument. 

```{r}
anova(reduced.combustion, full.combustion, test = 'Chisq') 
```

Here the chi-squared p value is not significant so the inclusion of the interaction term does not significantly decrease deviance and we can resume with the reduced model. 

We can also run a log -likelihood test using the ```lrtest()``` from the {lmtest} package 

```{r}
lrtest(reduced.combustion, full.combustion) 
```

Here the higher log likelihood value indicates a greater model fit, but again the chi-squared p value is not significant so even though the full model has a 'better' fit it is not significantly better. Therefore, again we can proceed with utilizing the reduced model for our analysis.  

Next, we must compare the accepted model, the reduced model, against the null model
```{r}
anova(null.combustion, reduced.combustion, test = 'Chisq') 
```

Here the chi-squared p value is less than alpha (.05) meaning the fuller model is associated with less residual deviance and therefore is a better fit! We can reject the null hypothesis that the removal of the predictor variables does not result in a loss of fit and proceed with utilizing the reduced model for our analysis. 

#### Interpretation 

Our slope estimate (Beta1) now represents the associated change in the response variable (which if we remember is the natural log of the odds ratio) with an increase in the predictor variable of 1 unit. 

The coefficient/estimate for the proportion of the soil organic layer was positive. Therefore increasing proportions of the SOL burned results in an increased likelihood of legacy C being combusted. For every one unit of proportion of SOL burned, the probability of legacy C being combusted increases by 12.52782. Where the estimate for stand age is negative indicating every year the stand ages, the likelihood of legacy C being combusted decreases by 0.05758. Even though neither of these relationships showed a significant p-value. 

In order to get the actual odds ratio we must back transform the estimates using the reverse of the link function.
```{r}
prop.sol.burned.change <- exp(reduced.combustion$coefficients[2]) 
stand.age.change <- exp(reduced.combustion$coefficients[3])

prop.sol.burned.change
stand.age.change
```

1 unit increase in SOL depth results in a 2.7x10^7 % increase in the likelihood of Legacy C combustion
1 unit increase in stand age results in a 5.6% decrease in the likelihood of Legacy C combustion

#### Hypothesis Testing 

To test our null hypothesis that the response variable (Legacy C presence) and our predictor variables have no relationship, we can calculate the Wald statistic (similar to a t-statistic) for each predictor variable and compare them to the z distribution. 

Calculating the Wald Statistic for proportion of SOL burned 
```{r}
modelresults <- tidy(reduced.combustion)
wald <- modelresults$estimate[2]/modelresults$std.error[2]
p <- 2 * (1 - pnorm(wald))  # calculation of 2 tailed p value associated with the Wald statistic
p
```

for stand age
```{r}
modelresults <- tidy(reduced.combustion)
wald <- modelresults$estimate[3]/modelresults$std.error[3]
p <- 2 * (1 - pnorm(wald))  # calculation of 2 tailed p value associated with the Wald statistic
p
```
 
Again neither predictor variable seems to show a significant p-value. 

#### Confidence Intervals 

Finally, we can calculate the confidence intervals around our estimates 
```{r}
CI <- confint.default(reduced.combustion, level = 0.95) # this function returns CIs based on standard errors instead of based on log-likelihood 
CI
```

Calculating the CIs for the actual odds ratios
```{r}
prop.sol.burned.changeCI <- exp(CI[2, ]) #for prefire SOL depth
stand.age.changeCI <- exp(CI[3, ]) #for stand age 

prop.sol.burned.changeCI
stand.age.changeCI
```

#### Plotting (Figure 3 from original paper) 

Transforming the factored combustion variable into a binary value for the ggplot object
```{r}
combustion.r.data$combust.bin <- NULL 
for (i in 1:nrow(combustion.r.data)) {
  if (combustion.r.data$combustion[i] == 'Combusted') {
    combustion.r.data$combust.bin[i] <- 1
  }
  else {
    combustion.r.data$combust.bin[i] <- 0
  }
}
```

Effect of proportion of SOL burned on the probability of legacy C combustion.
```{r}
effects.prop <- as.data.frame(effect('proportion_sol_burned', reduced.combustion, xlevels = 32))
```

```{r}
p <- ggplot(data = effects.prop, aes(x= proportion_sol_burned, y = fit)) + geom_line() + geom_ribbon(aes(ymin = effects.prop$lower, ymax = effects.prop$upper), alpha = .2) + labs(x = "Proportion SOL burned", y ="Pr(Combusted)", color = 'Moisture Class', shape = 'Stand Age') + geom_point(data = combustion.r.data, aes(x = proportion_sol_burned, y = combust.bin, color = moisture_class, shape = stand_age_class), size = 3.5) + theme_bw() + scale_color_manual(values = c('darkgreen', 'darkred','darkblue')) 
p
```

Effect of stand age on the probability of legacy C combustion.
```{r}
effects.age <- as.data.frame(effect('stand_age_rings', reduced.combustion, xlevels = 32))
```

```{r}
p <- ggplot(data = effects.age, aes(x= stand_age_rings, y = fit)) + geom_line() + geom_ribbon(aes(ymin = effects.age$lower, ymax = effects.age$upper), alpha = .2) + labs(x = "Stand Age (yr)", y ="Pr(Combusted)", color = 'Moisture Class', shape = 'Stand Age') + geom_point(data = combustion.r.data, aes(x = stand_age_rings, y = combust.bin, color = moisture_class, shape = stand_age_class), size = 3.5) + theme_bw() + scale_color_manual(values = c('darkgreen', 'darkred','darkblue')) + geom_vline(aes(xintercept = 60), linetype = 'dashed')
p
```


## Conclusion 

So overall I was able to reproduce general trends similar to the original data analysis. As stand age increased, the likelihood of legacy C presence and combustion both decreased. Legacy C combustion was more likely as the proportion of the SOL burned and the presence of legacy C became more likely as the prefire SOL depth increased. These trends indicate that more frequent fire intervals and increased fire severity under climate warming are threats to boreal forests ability to act as C sinks and counteract some of the C emissions contributing to greenhouse gas formation. 

Where I strayed was in the statistical significance of my generalized linear model results. The original authors were able to obtain significant results for all of their analyses. They did indicate that they used Firth's logistic regression using the {logistf} package instead of the standard glm() function in the {lmtest} package to account for highly predictive covariates that are common in generalized linear models using smaller sample sizes. Yet when I tried running the analysis under that package the p-values seemed to be even less significant.  

## References 

1) https://fuzzyatelin.github.io/bioanth-stats/module-17/module-17.html
2) https://fuzzyatelin.github.io/bioanth-stats/module-12/module-12.html
3) https://fuzzyatelin.github.io/bioanth-stats/module-15/module-15.html
4) https://daac.ornl.gov/ABOVE/guides/ABoVE_Soil_Radiocarbon_NWT.html
4) https://www-nature-com.ezproxy.bu.edu/articles/s41586-019-1474-y.pdf

